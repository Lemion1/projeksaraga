<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Booking - Saraga</title>
    <link rel="stylesheet" href="bookpage.css" />
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="back-btn" onclick="window.history.back()">
                ‚Üê Kembali ke Detail Venue
            </button>
        </div>

        <div class="booking-layout">
            <div class="venue-section">
                <div class="venue-header">
                    <div>
                        <div class="venue-title">Latansa Futsal Pekanbaru</div>
                        <div class="venue-location">üìç Tengkerang Utara, 3.5 km away</div>
                        <span class="status-badge status-available">Available</span>
                        <div class="info-row">‚è∞ 08:00 - 24:00 | üìÖ 6 players max</div>
                        
                        <button class="btn-maps" onclick="openGoogleMaps()">
                            üó∫Ô∏è Lihat di Maps / Get Directions
                        </button>

                    </div>
                    <div class="price-tag">
                        <div class="price-amount">Rp 80k/hr</div>
                        <div class="price-label">Peak hours</div>
                    </div>
                </div>

                <div class="schedule-section">
                    <div class="section-title">Pilih Tanggal & Waktu</div>
                    <div class="date-picker">
                        <input type="date" id="bookingDate" value="2025-11-12" />
                    </div>

                    <div class="time-slots" id="timeSlots">
                        <div class="time-slot booked" data-time="09:00">
                            <div class="time-slot-time">9:00 AM</div>
                            <div class="time-slot-status">Booked</div>
                        </div>
                        <div class="time-slot booked" data-time="10:00">
                            <div class="time-slot-time">10:00 AM</div>
                            <div class="time-slot-status">Booked</div>
                        </div>
                        <div class="time-slot available" data-time="11:00" data-price="80000">
                            <div class="time-slot-time">11:00 AM</div>
                            <div class="time-slot-status">Available</div>
                        </div>
                        <div class="time-slot available" data-time="12:00" data-price="100000">
                            <div class="time-slot-time">12:00 PM</div>
                            <div class="time-slot-status">Available</div>
                        </div>
                        <div class="time-slot booked" data-time="13:00">
                            <div class="time-slot-time">1:00 PM</div>
                            <div class="time-slot-status">Booked</div>
                        </div>
                        <div class="time-slot booked" data-time="14:00">
                            <div class="time-slot-time">2:00 PM</div>
                            <div class="time-slot-status">Booked</div>
                        </div>
                        <div class="time-slot booked" data-time="15:00" data-price="100000">
                            <div class="time-slot-time">3:00 PM</div>
                            <div class="time-slot-status">Booked</div>
                        </div>
                        <div class="time-slot booked" data-time="16:00">
                            <div class="time-slot-time">4:00 PM</div>
                            <div class="time-slot-status">Booked</div>
                        </div>
                        <div class="time-slot available" data-time="17:00" data-price="120000">
                            <div class="time-slot-time">5:00 PM</div>
                            <div class="time-slot-status">Available</div>
                        </div>
                        <div class="time-slot available" data-time="18:00" data-price="140000">
                            <div class="time-slot-time">6:00 PM</div>
                            <div class="time-slot-status">Available</div>
                        </div>
                        <div class="time-slot booked" data-time="19:00">
                            <div class="time-slot-time">7:00 PM</div>
                            <div class="time-slot-status">Booked</div>
                        </div>
                        <div class="time-slot available" data-time="20:00" data-price="140000">
                            <div class="time-slot-time">8:00 PM</div>
                            <div class="time-slot-status">Available</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="cart-section">
                <div class="cart-title">üõí Booking Cart</div>
                
                <div id="cartEmpty" class="cart-empty">
                    <div style="font-size: 48px; margin-bottom: 10px;">üèüÔ∏è</div>
                    <p>Pilih waktu booking untuk melanjutkan</p>
                </div>

                <div id="cartItems" style="display: none;"></div>

                <div id="cartSummary" class="cart-summary" style="display: none;">
                    <div class="summary-row">
                        <span>Subtotal</span>
                        <span id="subtotal">Rp 0</span>
                    </div>
                    <div class="summary-row">
                        <span>Service Fee</span>
                        <span id="serviceFee">Rp 5,000</span>
                    </div>
                    <div class="summary-row summary-total">
                        <span>Total</span>
                        <span id="total">Rp 0</span>
                    </div>
                </div>

                <div id="paymentSection" class="payment-section" style="display: none;">
                    <div class="section-title">Metode Pembayaran</div>
                    <div class="payment-methods">
                        <div class="payment-method" data-method="bank">üè¶</div>
                        <div class="payment-method" data-method="ewallet">üí≥</div>
                        <div class="payment-method" data-method="paypal">üíµ</div>
                    </div>
                    <button class="checkout-btn" id="checkoutBtn" disabled>Proceed to Checkout</button>
                </div>

                <div class="confirmation" id="confirmation">
                    <div class="confirmation-title">
                        ‚úÖ Booking Confirmed
                    </div>
                    <div class="confirmation-text">
                        Booking ID: #EB2024001<br />
                        Confirmation sent to email
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal-booking-success" id="processingModal">
        <div class="modal-content-processing">
            <div class="modal-icon-processing">‚è≥</div>
            <div class="modal-title-processing">Pembayaran Diproses</div>
            <div class="modal-body-success">
                <p>Menunggu pembayaran Anda melalui Virtual Account.</p>
                <div class="va-details">
                    <div class="va-row">
                        <span class="va-label">Metode Pembayaran</span>
                        <span class="va-value">Virtual Account Mandiri</span>
                    </div>
                    <div class="va-row">
                        <span class="va-label">Nomor Virtual Account</span>
                        <div>
                            <span class="va-value" id="vaNumber">8888000100001234</span>
                            <button class="va-copy-btn" onclick="copyToClipboard('vaNumber')">Salin</button>
                        </div>
                    </div>
                    <div class="va-row">
                        <span class="va-label">Jumlah Pembayaran</span>
                        <span class="va-value" id="vaAmount">Rp 0</span>
                    </div>
                </div>
                <p>Harap selesaikan pembayaran sebelum:</p>
                <div class="countdown-timer" id="paymentCountdown">15:00</div>
            </div>
            <button class="checkout-btn" onclick="window.location.href='booking.html'" style="background: #f3f4f6; color: #4b5563;">Kembali ke Booking</button>
        </div>
    </div>

    <div class="modal-booking-success" id="successModal">
        <div class="modal-content-success">
            <div class="modal-icon-success">üéâ</div>
            <div class="modal-title-success">Booking Berhasil!</div>
            <div class="modal-body-success">
                Pesanan Anda telah dikonfirmasi dan akan diarahkan ke halaman My Bookings.
            </div>
            <button class="checkout-btn" onclick="window.location.href='booking.html'">Lihat Booking Saya</button>
        </div>
    </div>
    
    <div class="modal-booking-success" id="failureModal">
        <div class="modal-content-failure">
            <div class="modal-icon-failure">‚ùå</div>
            <div class="modal-title-failure">Pembayaran Gagal</div>
            <div class="modal-body-success">
                <p>Waktu pembayaran telah habis atau transaksi dibatalkan.</p>
                <p>Silakan ulangi proses booking jika Anda masih ingin memesan venue ini.</p>
            </div>
            <button class="checkout-btn" style="background: #e53e3e; color: white;" onclick="closeAllModals()">Ulangi Booking</button>
            <button class="checkout-btn btn-secondary" onclick="window.location.href='home-udahlogin.html'" style="background: #f3f4f6; color: #4b5563; margin-top: 10px;">Cari Venue Lain</button>
        </div>
    </div>


    <script>
        let cart = [];
        let selectedPayment = null;
        const serviceFee = 5000;
        let paymentTimer; // For payment simulation
        let countdownInterval; // For visual countdown
        const PAYMENT_TIME_LIMIT = 900; // 15 minutes in seconds

        // Time slot selection (UNMODIFIED)
        document.querySelectorAll('.time-slot.available').forEach(slot => {
            slot.addEventListener('click', function() {
                if (this.classList.contains('booked')) return;
                
                const time = this.dataset.time;
                const price = parseInt(this.dataset.price);
                const date = document.getElementById('bookingDate').value;

                // Check if already in cart
                const existingIndex = cart.findIndex(item => item.time === time);
                
                if (this.classList.contains('selected')) {
                    // Remove from cart
                    this.classList.remove('selected');
                    cart.splice(existingIndex, 1);
                } else {
                    // Add to cart
                    this.classList.add('selected');
                    cart.push({
                        venue: 'Latansa Futsal Pekanbaru',
                        date: date,
                        time: time,
                        price: price
                    });
                }
                
                updateCart();
            });
        });

        // Payment method selection (UNMODIFIED)
        document.querySelectorAll('.payment-method').forEach(method => {
            method.addEventListener('click', function() {
                document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('selected'));
                this.classList.add('selected');
                selectedPayment = this.dataset.method;
                document.getElementById('checkoutBtn').disabled = false;
            });
        });

        // NEW: Close Modals and Reset State
        function closeAllModals() {
            document.getElementById('processingModal').classList.remove('active');
            document.getElementById('successModal').classList.remove('active');
            document.getElementById('failureModal').classList.remove('active');
            
            // Re-enable cart section display in case of failure/cancellation
            if (cart.length > 0) {
                document.getElementById('cartSummary').style.display = 'block';
                document.getElementById('paymentSection').style.display = 'block';
                document.getElementById('cartItems').style.display = 'block';
            }

            clearInterval(paymentTimer);
            clearInterval(countdownInterval);
        }

        // NEW: Start Payment Countdown
        function startCountdown() {
            let timeLeft = PAYMENT_TIME_LIMIT;
            const timerEl = document.getElementById('paymentCountdown');
            
            clearInterval(countdownInterval);
            countdownInterval = setInterval(() => {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                timeLeft--;

                if (timeLeft < 60) {
                    timerEl.style.color = '#e53e3e'; // Merah saat 1 menit terakhir
                } else {
                    timerEl.style.color = '#1a202c'; // Warna normal
                }

                if (timeLeft < 0) {
                    clearInterval(countdownInterval);
                    handlePaymentResult(false); // Force failure if time runs out
                }
            }, 1000);
        }

        // NEW: Handle Payment Result (Simulated)
        function handlePaymentResult(isSuccess) {
            clearInterval(paymentTimer);
            clearInterval(countdownInterval);
            document.getElementById('processingModal').classList.remove('active'); // Hide processing modal
            
            if (isSuccess) {
                // Show Success Modal
                document.getElementById('successModal').classList.add('active');
                
                // Mark selected slots as booked permanently
                 document.querySelectorAll('.time-slot.selected').forEach(slot => {
                    slot.classList.add('booked');
                    slot.classList.remove('selected');
                });

                // Simulate redirection after successful payment confirmation
                setTimeout(() => {
                    window.location.href = 'booking.html'; 
                }, 2500);

            } else {
                // Show Failure Modal
                document.getElementById('failureModal').classList.add('active');
                
                // Clear selections on failure
                document.querySelectorAll('.time-slot.selected').forEach(slot => {
                    slot.classList.remove('selected');
                    slot.classList.remove('booked'); // Remove temporary booked status
                });
            }
        }
        
        // NEW: Copy to Clipboard function
        function copyToClipboard(elementId) {
            const textToCopy = document.getElementById(elementId).textContent;
            navigator.clipboard.writeText(textToCopy);
            alert('Nomor Virtual Account disalin: ' + textToCopy);
        }
        
        // MODIFIED: Checkout Logic
        document.getElementById('checkoutBtn').addEventListener('click', function() {
            if (cart.length === 0 || !selectedPayment) return;
            
            const subtotal = cart.reduce((sum, item) => sum + item.price, 0);
            const total = subtotal + serviceFee;
            
            // 1. Mark selected slots as 'booked' temporarily during processing
            document.querySelectorAll('.time-slot.selected').forEach(slot => {
                slot.classList.add('booked');
            });

            // 2. Hide cart/payment sections
            document.getElementById('cartSummary').style.display = 'none';
            document.getElementById('paymentSection').style.display = 'none';
            document.getElementById('cartItems').style.display = 'none';
            document.getElementById('confirmation').classList.remove('show');
            
            // 3. Show Processing Modal
            document.getElementById('vaAmount').textContent = 'Rp ' + formatPrice(total);
            document.getElementById('processingModal').classList.add('active');
            
            // Start countdown
            startCountdown();

            // 4. Start Payment Simulation (20% chance of failure after 5 seconds)
            // Simulating user sending balance to VA
            paymentTimer = setTimeout(() => {
                const isSuccess = Math.random() > 0.2; // 80% success chance
                handlePaymentResult(isSuccess);
            }, 5000); // Wait 5 seconds to simulate payment processing
        });
        
        // NEW: Close modal when clicking outside (added for new modals)
        document.getElementById('processingModal').addEventListener('click', function(e) {
            if (e.target === this) {
                // Do not automatically close processing modal, user must click button or time runs out
            }
        });
        
        document.getElementById('failureModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeAllModals();
            }
        });
        
        document.getElementById('successModal').addEventListener('click', function(e) {
            if (e.target === this) {
                // Automatically redirects on timer, no need to handle manual close
            }
        });


        // NEW: Close modal when clicking outside (added for new modals)
        document.getElementById('processingModal').addEventListener('click', function(e) {
            if (e.target === this) {
                // Do not automatically close processing modal, user must click button or time runs out
            }
        });

        // EXISTING: openGoogleMaps function (UNMODIFIED)
        function openGoogleMaps() {
            const venueName = 'Latansa Futsal Pekanbaru';
            
            // SIMULASI KOORDINAT/ALAMAT (Ganti dengan koordinat sebenarnya)
            const latitude = -0.5186; 
            const longitude = 101.4468; 

            // Cek koneksi internet (Simulasi Flow Alt 3.4)
            if (!navigator.onLine) {
                alert('Tidak dapat membuka Google Maps karena tidak ada koneksi internet. Gunakan navigasi manual.');
                return;
            }

            // URL Google Maps untuk rute (Flow 3.1 & 3.2)
            const mapsUrl = `https://maps.app.goo.gl/TBKmvAzPxCHcG6oW8`;

            // Buka tab baru berisi peta Google Maps
            window.open(mapsUrl, '_blank');
        }

        // EXISTING: updateCart function (MODIFIED SLIGHTLY to use closeAllModals)
        function updateCart() {
            const cartEmpty = document.getElementById('cartEmpty');
            const cartItems = document.getElementById('cartItems');
            const cartSummary = document.getElementById('cartSummary');
            const paymentSection = document.getElementById('paymentSection');

            if (cart.length === 0) {
                cartEmpty.style.display = 'block';
                cartItems.style.display = 'none';
                cartSummary.style.display = 'none';
                paymentSection.style.display = 'none';
                closeAllModals(); // Ensure all modals are closed when cart is cleared
                return;
            }

            cartEmpty.style.display = 'none';
            cartItems.style.display = 'block';
            cartSummary.style.display = 'block';
            paymentSection.style.display = 'block';

            // Render cart items
            cartItems.innerHTML = cart.map((item, index) => `
                <div class="cart-item">
                    <div class="cart-item-header">
                        <div class="cart-item-venue">${item.venue}</div>
                        <button class="cart-item-remove" onclick="removeFromCart(${index})">√ó</button>
                    </div>
                    <div class="cart-item-details">
                        ${formatDate(item.date)} ‚Ä¢ ${formatTime(item.time)}
                    </div>
                    <div class="cart-item-price">Rp ${formatPrice(item.price)}</div>
                </div>
            `).join('');

            // Calculate totals
            const subtotal = cart.reduce((sum, item) => sum + item.price, 0);
            const total = subtotal + serviceFee;

            document.getElementById('subtotal').textContent = 'Rp ' + formatPrice(subtotal);
            document.getElementById('total').textContent = 'Rp ' + formatPrice(total);
        }
        
        // EXISTING: removeFromCart (UNMODIFIED)
        function removeFromCart(index) {
            const item = cart[index];
            
            // Unselect time slot
            document.querySelectorAll('.time-slot').forEach(slot => {
                if (slot.dataset.time === item.time) {
                    slot.classList.remove('selected');
                }
            });
            
            cart.splice(index, 1);
            updateCart();
        }

        // EXISTING: Helper functions (UNMODIFIED)
        function formatPrice(price) {
            return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const options = { day: 'numeric', month: 'short', year: 'numeric' };
            return date.toLocaleDateString('id-ID', options);
        }

        function formatTime(time) {
            const [hours, minutes] = time.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour > 12 ? hour - 12 : hour;
            return `${displayHour}:${minutes} ${ampm}`;
        }
    </script>
</body>

</html>
